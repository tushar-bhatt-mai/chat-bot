const chatBox=document.getElementById("chat-box"),userInput=document.getElementById("user-input"),baseUrl="https://dev-maibot-predictionapi.p2eppl.com/";let chatBotResult={};const params=parseQueryString(window.location.href);let accessToken=params?.token,refreshToken=params?.refreshToken;var loading=!1;const loggedInUserData=e=>{const t=e?.display_name.split(" ").map((e=>e[0])).join(""),s=document.getElementById("roundedName");var a=document.createElement("img");a.src=`${e?.profile_picture_url}`,a.classList.add("imgStyle"),"NA"!==e?.profile_picture_url?s.appendChild(a):e?.display_name?(s.style.backgroundColor="#6D1874",s.innerHTML=`${t}`):s.style.backgroundColor="transparen"};function initialMessage(){loggedInUserData(chatBotResult);const e=document.getElementById("chat-Navbar");chatBotResult?.background_colour?e.style.backgroundColor=chatBotResult?.background_colour:e.classList.add("bgColor");document.getElementById("display-chat").innerHTML=chatBotResult?.display_name?"Chat With":"",document.getElementById("display-name").innerHTML=`${chatBotResult?.display_name?chatBotResult?.display_name:""}`;const t=document.getElementById("initialValue");t.innerHTML=`<span class='bot-message'>${chatBotResult?.initial_message?chatBotResult?.initial_message:"Initial Message"}</span>`,t.style.fontSize=chatBotResult?.font_size||"12px",t.style.fontFamily=chatBotResult?.font_style||"Arial, sans-serif",displaySuggestedMessages(chatBotResult?.suggested_messages||[])}function displaySuggestedMessages(e){const t=document.getElementById("suggested-messages");t.innerHTML="",e.forEach((e=>{const s=document.createElement("button");s.textContent=e,s.classList.add("suggestion-button"),s.onclick=function(){fillInputAndSendMessage(e)},t.appendChild(s)}))}function fillInputAndSendMessage(e){document.getElementById("user-input").value=e,sendMessage(),document.getElementById("suggested-messages").style.display="none"}function parseQueryString(e){const t=e.split("?")[1],s=new URLSearchParams(t);return Object.fromEntries(s.entries())}function sendMessage(){const e=userInput.value.trim();if(!e)return;displayMessage(e,"user",!1),userInput.value="";const t=new Headers;t.append("Authorization",`Bearer ${accessToken}`);const s=new FormData;s.append("username",params.username),s.append("modelname",params.modelname),s.append("question",e),s.append("source_language_code","en"),loading=!0,fetch(baseUrl,{method:"POST",headers:t,body:s,redirect:"follow"}).then((e=>e.text())).then((e=>{var t=JSON.parse(e||"{}");console.log("parse result"),401==t.StatusCode?(fetchRefreshtoken(),displayMessage("Something went Wrong, Please try again","bot",!0)):(JSON.stringify(e),displayMessage(JSON.parse(e)?.message,"bot",!0),loading=!1)})).catch((e=>{console.error("error",e)})).finally((()=>{loading=!1}))}function scrollToBottom(){var e=document.getElementById("chat-box");e&&(e.scrollTop=e.scrollHeight)}function getChatbotDetails(){const e=new Headers;e.append("Authorization",`Bearer ${accessToken}`);const t=new FormData;t.append("username",params.username),t.append("chatbot_name",params.chatbotname),fetch("https://dev-maibot-chatbot-detailapi.p2eppl.com/get_chatbot_customization",{method:"POST",headers:e,body:t,redirect:"follow"}).then((e=>e.text())).then((e=>{const t=JSON.parse(e);200===t.statusCode&&(chatBotResult=t.message,initialMessage())})).catch((e=>console.error("error",e)))}function displayMessage(e,t,s){const a=document.createElement("div");a.classList.add("user"===t?"user-messageDev":"bot-messageDev");const n=document.createElement("span");if(n.classList.add("user"===t?"user-message":"bot-message"),loading&&s&&"bot"===t){const t=document.createElement("div");t.className="loader";for(let e=0;e<3;e++){const e=document.createElement("span");t.appendChild(e)}n.appendChild(t),setTimeout((()=>{t.style.display="none",n.textContent=e}),1e3)}else n.textContent=e;loading=!1,a.appendChild(n),chatBox.appendChild(a),scrollToBottom()}getChatbotDetails();const fetchRefreshtoken=async()=>{try{const e=await fetch("https://dev-auth2api.p2eppl.com/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:refreshToken})}),t=await e.json();t?.result&&(accessToken=t?.result?.access_token,sendMessage())}catch(e){console.error(e)}};